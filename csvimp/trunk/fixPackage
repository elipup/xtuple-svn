#
# This file is part of the xTuple ERP: PostBooks Edition, a free and
# open source Enterprise Resource Planning software suite,
# Copyright (c) 1999-2009 by OpenMFG LLC, d/b/a xTuple.
# It is licensed to you under the Common Public Attribution License
# version 1.0, the full text of which (including xTuple-specific Exhibits)
# is available at www.xtuple.com/CPAL.  By using this software, you agree
# to be bound by its terms.
#
#!/bin/bash

if [ -z "$QTDIR" ] ; then
  QTDIR=/usr/local/Trolltech/Qt-4.2.3
fi
if ! [ -d $QTDIR ] ; then
  echo "Canot find QTDIR"
  exit
fi

if [ -z "$PGDIR" ] ; then
  PGDIR=$QTDIR
fi
if ! [ -d $PGDIR/lib ] ; then
  echo "Cannot find PGDIR/lib"
  exit
fi

FRAMEWORKSDIR=csvimp.app/Contents/Frameworks
if ! [ -d "$FRAMEWORKSDIR" ] ; then
  mkdir $FRAMEWORKSDIR
fi
cd $FRAMEWORKSDIR

cp $QTDIR/lib/libQt3Support.4.dylib \
	      $QTDIR/lib/libQtNetwork.4.dylib \
	      $QTDIR/lib/libQtSql.4.dylib 	 \
	      $QTDIR/lib/libQtXml.4.dylib 	 \
	      $QTDIR/lib/libQtGui.4.dylib 	 \
	      $QTDIR/lib/libQtCore.4.dylib 	 \
	      $PGDIR/lib/libpq.4.dylib	 .

install_name_tool -id @executable_path/../Frameworks/libpq.4.dylib libpq.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQt3Support.4.dylib libQt3Support.4.dylib
install_name_tool -change $QTDIR/lib/libQtSql.4.dylib @executable_path/../Frameworks/libQtSql.4.dylib libQt3Support.4.dylib
install_name_tool -change $QTDIR/lib/libQtXml.4.dylib @executable_path/../Frameworks/libQtXml.4.dylib libQt3Support.4.dylib
install_name_tool -change $QTDIR/lib/libQtGui.4.dylib @executable_path/../Frameworks/libQtGui.4.dylib libQt3Support.4.dylib
install_name_tool -change $QTDIR/lib/libQtNetwork.4.dylib @executable_path/../Frameworks/libQtNetwork.4.dylib libQt3Support.4.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libQt3Support.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQtNetwork.4.dylib libQtNetwork.4.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libQtNetwork.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQtSql.4.dylib libQtSql.4.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libQtSql.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQtXml.4.dylib libQtXml.4.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libQtXml.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQtGui.4.dylib libQtGui.4.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libQtGui.4.dylib

install_name_tool -id @executable_path/../Frameworks/libQtCore.4.dylib libQtCore.4.dylib

cd ../MacOS
install_name_tool -change $QTDIR/lib/libQt3Support.4.dylib @executable_path/../Frameworks/libQt3Support.4.dylib csvimp
install_name_tool -change $QTDIR/lib/libQtNetwork.4.dylib @executable_path/../Frameworks/libQtNetwork.4.dylib csvimp
install_name_tool -change $QTDIR/lib/libQtSql.4.dylib @executable_path/../Frameworks/libQtSql.4.dylib csvimp
install_name_tool -change $QTDIR/lib/libQtXml.4.dylib @executable_path/../Frameworks/libQtXml.4.dylib csvimp
install_name_tool -change $QTDIR/lib/libQtGui.4.dylib @executable_path/../Frameworks/libQtGui.4.dylib csvimp
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib csvimp

if ! [ -d "../plugins" ]; then
  mkdir ../plugins
fi
cd ../plugins

if ! [ -d "sqldrivers" ]; then
  mkdir sqldrivers
fi
cd sqldrivers

cp $QTDIR/plugins/sqldrivers/libqsqlpsql.dylib .
install_name_tool -change $QTDIR/lib/libQtSql.4.dylib @executable_path/../Frameworks/libQtSql.4.dylib libqsqlpsql.dylib
install_name_tool -change $QTDIR/lib/libQtCore.4.dylib @executable_path/../Frameworks/libQtCore.4.dylib libqsqlpsql.dylib
install_name_tool -change $PGDIR/lib/libpq.4.dylib @executable_path/../Frameworks/libpq.4.dylib libqsqlpsql.dylib

cd ../..

if ! [ -d "Resources" ]; then
  mkdir Resources
fi
cd Resources

echo "[Paths]" > qt.conf
echo "Prefix = .." >> qt.conf
