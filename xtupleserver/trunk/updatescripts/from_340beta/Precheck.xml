 <prerequisite type="Query" name="Valid Country Check" >
  <query> SELECT SUM(counter) &lt;= 0 FROM (
        SELECT COUNT(*) AS counter
          FROM addr
         WHERE addr_country != ''
           AND addr_country NOT IN (SELECT country_name
                                    FROM country
                                    WHERE country_name IS NOT NULL)
        UNION ALL
        SELECT COUNT(*)
          FROM cmhead
         WHERE (NOT cmhead_posted)
           AND ((cmhead_billtocountry != '' AND
                 cmhead_billtocountry NOT IN (SELECT country_name
                                              FROM country
                                              WHERE country_name IS NOT NULL))
             OR (cmhead_shipto_country != '' AND
                 cmhead_shipto_country NOT IN (SELECT country_name
                                               FROM country
                                               WHERE country_name IS NOT NULL))
               )
        UNION ALL
        SELECT COUNT(*)
          FROM invchead
         WHERE (NOT invchead_posted)
           AND ((invchead_billto_country != '' AND
                 invchead_billto_country NOT IN (SELECT country_name
                                                 FROM country
                                                 WHERE country_name IS NOT NULL))
             OR (invchead_shipto_country != '' AND
                 invchead_shipto_country NOT IN (SELECT country_name
                                                 FROM country
                                                 WHERE country_name IS NOT NULL))
               )
        UNION ALL
        SELECT COUNT(*)
          FROM quhead
         WHERE (quhead_expire >= CURRENT_DATE)
           AND ((quhead_billtocountry != '' AND
                 quhead_billtocountry NOT IN (SELECT country_name
                                              FROM country
                                              WHERE country_name IS NOT NULL))
             OR (quhead_shiptocountry != '' AND
                  quhead_shiptocountry NOT IN (SELECT country_name
                                               FROM country
                                               WHERE country_name IS NOT NULL))
               )
        UNION ALL
        SELECT COUNT(*)
          FROM cohead JOIN coitem ON (cohead_id=coitem_cohead_id
                                 AND COALESCE(coitem_status, 'O')='O')
         WHERE ((cohead_billtocountry != '' AND
                 cohead_billtocountry NOT IN (SELECT country_name
                                              FROM country
                                              WHERE country_name IS NOT NULL))
             OR (cohead_shiptocountry != '' AND
                 cohead_shiptocountry NOT IN (SELECT country_name
                                             FROM country
                                             WHERE country_name IS NOT NULL))
               )
         ) AS dummy;

         </query>
  <message>There are addresses in this database containing countries which are not listed in the table of countries. These must be fixed before you can upgrade. To help with this, please download and install the pre_3.4.0beta2.gz package available for download here: http://sourceforge.net/projects/postbooks/files/. To fix your countries, open the main xTuple ERP application as an administrative user and select CRM -> Utilities -> Fix Countries Before Upgrading to 3.4.0.
</message>
 </prerequisite>
